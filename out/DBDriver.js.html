<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: DBDriver.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: DBDriver.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const config = require('./config');
const StorageEngine = require(config.storage_engine);
const EventEmitter = require('events');
const queryAndProjection= require('./operators/queryAndProjection');

class DBDriverError extends Error{
 constructor(message){  
  super(message);
  this.name = 'DBDriverError';
 }
}
/**
 * Database driver implementation with an intended use in conjunction with 
 * the steg @see https://github.com/hantyrram/steg package. Serves as a 
 * layer on top, making the steg package the storage engine. 
 * 
 * This can also be used with other storage engine implementations
 * conforming to the steg storage engine's interface
 * 
 * DBDriver extends EventEmitter
 * @class
 */
class DBDriver extends EventEmitter{
 constructor(pathToDataSource){  
  super();
  this.pathToDataSource = pathToDataSource;
  this.data = {
   collections: {}
  };
 }

 /**
  * Prepares the storage engine.
  * @return {Promise} - Which resolves to an initialized instance of DBDriver. This method MUST be called
  * to get the initialized instance of the DBDriver before it can be used.
  */
 async init(){

  let self = this;
  //returns a promise that resolved to a 'ready' storageEngine
  let storageEngine = new StorageEngine(self.pathToDataSource);

  try {
    self.storageEngine = await storageEngine.init();  
  } catch (error) {
    throw error;
  }

  if(self.storageEngine.sizeOfData !== 0){
    self.data = JSON.parse(self.storageEngine.read());
  }

  let collectionNames = Object.getOwnPropertyNames(self.data.collections);
  //if storageEngine.read() returns an empty string which is the default when the dataSource has no data
    //initialize the DBDriver.data to an empty object otherwise JSON.parse the data from the dataSource
  //if there are no collections yet, self.data === {} resolve DBDriver with an empty data
  if(collectionNames.length === 0){
   return self;
  }
  //else add the collection names as property of the DBDriver so it can be access like so: DBDriver.collection
  if(collectionNames.length > 0){
    collectionNames.forEach((collectionName)=>{
     if(self[collectionName] === undefined){//if the collection name is not yet a property of StegDB
      self.createCollection(collectionName,self.data.collections[collectionName.documents]);      
     }       
    });
  }
  return self;
 }


 /**
  * Inserts a single document unto the collection.
  * @param {String} collectionName The name of the collection.
  * @param {Object} document - Document to insert on to the collection.
  * @return {Object} writeResult - With single property insertedId.
  * @throws {DBDriverError} - if the collectionName does not exist.
  */
 insertOne(collectionName,document){
  let collection =  this.data.collections[collectionName];
  if(collection !== undefined){
   document._id =  collection._idGenerator.next().value;
   collection.documents.push(document);

   let writeResult = {
     insertedId: document._id
   }

   return writeResult;
  }
  throw new DBDriverError('Collection Does Not Exist');
 } 

 /**
  * Inserts multiple documents.
  * @param {String} collectionName - The name of the collection.
  * @param {Array} documents - Documents to insert.
  * @return {Object} bulkWriteResult
  */
 insertMany(collectionName,documents){

  let bulkWriteResult = {
    insertedIds: []
  };

  documents.forEach(document=>{
    bulkWriteResult.insertedIds.push(this.insertOne(collectionName,document));
  });

  return bulkWriteResult;
 }

 /**
 * 
 * @param {String} collectionName - To select from
 * @return {Array|Object} - An array of documents if collectionName is passed or the entire database if collection is not specified
 */
 selectAll(collectionName){
  if(collectionName){     
   return this.data.collections[collectionName];
  }
  return this.data.collections;
 }

 /**
  * Creates a new collection. Adds the collectionName as property of this class. So that the collection
  * is accessible as a property of this class.

  * @var {String} collectionName - The collection name
  * @var {Array} documents - Array of Objects/Documents. Default = []
  * @return {Number} - The index of the created collection
  */
 createCollection(collectionName,documents = []){

  let self = this;  

  if(self[collectionName]) throw new DBDriverError('Collection Name Already Exists');
  // create a Collection object with methods borrowed from DBDriver
  let collection = {};
  collection.name = collectionName;
  collection.documents = documents;
  collection.insertOne = self.insertOne.bind(self,collectionName);
  collection.selectAll = self.selectAll.bind(self,collectionName);
  collection.findOne = self.findOne.bind(self,collectionName);
  collection.insertMany = self.insertMany.bind(self,collectionName);
  //add the id generator to the newly created collection so that it can generate ids 
  Object.defineProperty(collection,'_idGenerator',{
    value: _idGenerator(_retrieveLastId(collection.documents)), //this here is the collection object
    configurable: false,
    writable: false
  });
  //add the collection as a property to db
  Object.defineProperty(self,collectionName,
   {
     get : function(){
       self.data.collections[collectionName] = collection;
       return self.data.collections[collectionName];
     } 
   });
   
   return self[collectionName];
 }

 /**
  * Returns one/first document that satisfies the specified query criteria on the collection
  * @see https://docs.mongodb.com/manual/reference/method/db.collection.findOne/
  * @param {Object} query 
  * @param {Object} projection 
  * @return {Object} a single document that satisfies the query,projection criteria, null if not found
  */
 findOne(collectionName,query,projection){
  let collection = this.data.collections[collectionName];  
  if(!collection) return null;
  if(!query || Object.getOwnPropertyNames(query).length === 0){//if query = {}
    return collection.documents.find(doc=>{//return first document
      if(doc) return true;
    });
   }

  //only the first result to returns an Array
  return queryAndProjection.apply(query).to(collection.documents)[0];

 }

  
  
}

//Internal functions
 
/**
 * Retrieves the last Secret ID that can be used from the secrets array.
 * The value returned
 * @param {Array} documents - The array where Secret Objects are stored
 * @return {Number} - The last used id/highest number + 1;
 */
function _retrieveLastId(documents){
 let id;

 if(documents.length === 0){
  
  id = 1;

  return id;
  
 }else{
 
  id = documents.reduce(function(accumulator,currentElement){
   if(accumulator &lt; currentElement._id){
    accumulator = currentElement._id;		
   } 
   return accumulator;
  },0);
  
  id = id + 1;

  return id;
 }
 
}

/**
 * Generates, Yields sequential number;
 * @param {Number} index - The starting number to use when generating id;
 */ 
function  *_idGenerator(index){
  let id = index;
  while(true){
   yield id++;
  }
}




module.exports = DBDriver;







</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="DBDriver.html">DBDriver</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_idGenerator">_idGenerator</a></li><li><a href="global.html#_retrieveLastId">_retrieveLastId</a></li><li><a href="global.html#documents">documents</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jul 20 2018 00:26:35 GMT+0300 (GMT+03:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
